<html xmlns:th="//www.thymeleaf.org" xmlns:field="//github.com/grundner" th:remove="tag"
      th:replace="page(body=~{::body})">
<th:block th:fragment="body" th:with="fragment=${form.fragment}">

    <style type="text/css">
        .btn-file {
        position: relative;
        overflow: hidden;
        }
        .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
        }
    </style>

    <div class="container" th:with="structure=${fragment.structure}">

        <!-- Title -->
        <div class="row">
            <fieldset class="col-md-12">
                <h1>
                    <span>Fragment</span>
                    <small>
                        <span>[[${fragment.structure.name}]]</span>
                        <span class="badge">[[${fragment.id} ?: _]]</span>
                    </small>
                </h1>
            </fieldset>
        </div>

        <!-- Title 2 -->
        <div class="row">
            <fieldset class="col-md-12">
                <h2>

                </h2>
            </fieldset>
        </div>

        <!-- Breadcrumb -->
        <div class="row">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    <li th:each="reference : ${references}">
                        <a th:href="@{edit(id=${reference.fragmentId})}">
                            [[${reference}]]
                        </a>

                    </li>
                    <li class="active">
                        [[${fragment.name}]]
                    </li>
                </ol>
            </div>
        </div>

        <div class="row">
            <fieldset class="col-md-12">
                <div th:if="${dirty}" class="alert alert-warning" role="alert">
                    Speichern nicht vergessen!
                </div>
            </fieldset>
        </div>

        <div class="row">

            <form th:object="${form}" enctype="multipart/form-data">

                <input type="hidden" th:field="*{referringValueId}">

                <!-- Attributes -->
                <div class="col-sm-8">
                    <h3>Attributes</h3>
                    <div class="row">
                        <div class="col-md-12">

                            <input type="hidden" th:field="*{fragment.structure}">
                            <input type="hidden" th:field="*{fragment.id}">
                            <input type="hidden" th:field="*{fragment.locale}">
                            <input type="hidden" th:field="*{fragment.translationBundle}">
                            <input type="hidden" th:field="*{fragment.parent}">

                            <div class="form-group">
                                <label class="control-label">Locale</label>
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-flag"></i>
                                    </span>
                                    <input type="text" class="form-control"
                                           readonly="readonly" th:value="${fragment.locale.displayName}">
                                </div>
                            </div>

                            <div class="form-group" th:classappend="${#fields.hasErrors('fragment.name')}? has-error">
                                <label th:for="name" th:text="*{fragment.name}">Field label</label>
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-tag"></i>
                                    </span>
                                    <input id="name" class="form-control" th:field="*{fragment.name}">
                                </div>

                                <p th:if="${#fields.hasErrors('fragment.name')}" th:errors="*{fragment.name}">Incorrect date</p>
                            </div>

                            <th:block th:each="field : ${structure.fields.values()}"
                                      th:with="attribute=${fragment.getAttribute(field)}">

                                <!-- Sequence -->
                                <th:block th:if="${field.sequence}" >
                                    <!--th:with="hasErrors=${#fields.hasErrors('content.attributes[__${field.name}__]*')}"-->

                                    <!--<div class="panel" th:classappend="${hasErrors} ? 'panel-danger' : 'panel-default'">-->
                                    <div class="panel" th:classappend="${hasErrors} ? 'panel-danger' : 'panel-default'">
                                        <div class="panel-heading">
                                            <strong th:text="${field.name}">Field title</strong>
                                        </div>
                                        <div class="panel-body">

                                            <!-- Errors regarding the whole attribute -->
                                            <!--<th:block th:if="${hasErrors}">-->
                                                <!--<div class="alert alert-danger" th:each="err : ${#fields.errors('content.attributes[__${field.name}__]')}" th:text="${err}">Input is incorrect</div>-->
                                            <!--</th:block>-->

                                            <th:block th:replace="fragment/field/__${field.constraint.inputType}__"
                                                      th:with="attribute?.value"/>

                                            <div class="btn-group btn-group-xs">
                                                <button formmethod="post"
                                                        th:formaction="@{edit(addvalue=${field.name})}"
                                                        class="btn btn-sm btn-default btn-block">
                                                    <i class="glyphicon glyphicon-plus"></i>
                                                    <span>Add value</span>
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </th:block>
                                <!-- Sequence End -->


                                <!-- Field -->
                                <th:block th:unless="${field.sequence}">
                                    <div class="form-group">
                                        <!--th:classappend="${#fields.hasErrors('content.attributes[__${field.name}__].values[0]')}? has-error"-->
                                        <label th:for="${field.name}" th:text="${field.name}">Field label</label>
                                        <th:block th:replace="fragment/field/__${field.constraint.inputType}__"
                                                  th:with="attribute?.value"/>
                                    </div>
                                </th:block>
                                <!-- Field End -->

                            </th:block>

                            <button formmethod="post"
                                    th:formaction="@{/fragments/save(id=${fragment.id})}"
                                    type="submit" class="btn btn-primary">
                                <i class="glyphicon glyphicon-save"></i>
                                <span>Save</span>
                            </button>

                            <input type="hidden" th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}"/>


                        </div>
                    </div>
                </div>

                <!-- Translations -->
                <div class="col-sm-4">
                    <h3>Translations</h3>

                    <strong>Progress:</strong>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0"
                             aria-valuemax="100" style="width: 60%;">
                            <span>60%</span>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <table class="table">
                            <tr th:each="l : ${supportedLocales}" th:classappend="${locale == l}? info">

                                <td>
                                    <a th:text="${l.displayName}"
                                       th:href="@{edit(id=${fragment?.id},locale=${l})}">
                                    </a>
                                </td>

                                <td>
                                    <div class="btn-group btn-group-xs pull-right">
                                        <button class="btn btn-default"
                                                th:formaction="@{/fragments/translate(id=${fragment.id},locale=${l.toLanguageTag()})}"
                                                formmethod="post">
                                            Translate
                                        </button>
                                    </div>
                                </td>

                            </tr>
                        </table>
                    </div>

                </div>
                <!-- Translations End -->

                <!-- Hierarchy -->
                <div class="col-sm-4">

                    <th:block th:unless="${fragment.id == null && fragment.parent == null}"
                              th:with="node=${fragment.root}">

                        <h3>Hierarchy</h3>

                        <div class="panel panel-default">
                            <!--<div class="panel-heading">-->
                            <!--Foobar-->
                            <!--</div>-->
                            <table class="tree table">

                                <tr th:fragment="treenode"
                                    th:class="'treegrid-' + ${node.id}"
                                    th:classappend="|${node.parent != null ? ('treegrid-parent-' + node.parent?.id) : ''}
                                                 ${node.id == fragment.id ? 'info' : ''}|">
                                    <td>
                                        <a th:text="${node?.name}" th:href="@{edit(id=${node.id})}">#</a>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-xs pull-right">
                                            <a class="btn btn-default">
                                                <i class="fa fa-arrow-up"></i>
                                            </a>
                                            <a class="btn btn-default">
                                                <i class="fa fa-arrow-down"></i>
                                            </a>
                                            <a class="btn btn-default"
                                               th:href="@{create(structure=${fragment.structure.name},parent=${node.id})}">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>

                                <th:block th:fragment="tree" th:each="child : ${node.children}">
                                    <tr th:replace="::treenode(node=${child})"></tr>
                                    <th:block th:if="${!child.children.empty}">
                                        <th:block th:replace="::tree(node=${child})"/>
                                    </th:block>
                                </th:block>

                            </table>

                        </div>
                    </th:block>


                    <!--<a class="btn btn-sm btn-primary"-->
                    <!--th:href="@{create(structure=${content.structure.name},parent=${content.id})}">-->
                    <!--<span>Add child</span>-->
                    <!--</a>-->
                </div>
                <!-- Hierarchy End -->

            </form>

        </div>
    </div>
</th:block>
</html>